<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thank You! Your AI Audit is Ready</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small “scroll margin” so anchored headers aren’t hidden under fixed top elements (if any). */
    h3[id] {
      scroll-margin-top: 2rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex flex-col justify-center items-center p-4">
    <div class="w-full max-w-3xl">
      <!-- Main Heading -->
      <h1 class="text-4xl font-extrabold text-center mb-4">
        Thank you! Your AI Audit is Ready
      </h1>
      <p class="text-center text-lg text-gray-600 mb-8">
        Please hold on while we prepare a detailed, in-depth report tailored to your business.
      </p>
      <!-- Loading Spinner -->
      <div id="loading" class="flex justify-center mb-8">
        <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
          </path>
        </svg>
      </div>
      <!-- TOC & Report Container -->
      <div id="reportContainer" class="hidden bg-white p-6 rounded-lg shadow-md">
        <!-- Table of Contents -->
        <div id="tableOfContents" class="mb-8">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Table of Contents</h2>
          <ul id="tocList" class="list-disc list-inside text-gray-700 space-y-2">
            <!-- Populated by JS -->
          </ul>
        </div>
        <!-- Report Content -->
        <div id="reportContent" class="text-base leading-relaxed text-gray-800 space-y-6">
          <!-- Injected by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      // 1) Grab session_id from URL
      const params = new URLSearchParams(location.search);
      const session_id = params.get('session_id');
      if (!session_id) {
        document.getElementById('loading').style.display = 'none';
        const rc = document.getElementById('reportContainer');
        rc.classList.remove('hidden');
        rc.innerHTML = '<p class="text-red-600 text-center">Error: Missing session_id in URL.</p>';
        return;
      }

      try {
        // 2) Fetch the advanced audit JSON
        const response = await fetch('https://api.aiauditpro.com/api/advanced-audit.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id })
        });

        // Handle non-2xx responses
        if (!response.ok) {
          const errJson = await response.json().catch(() => ({}));
          const msg = errJson.error?.message || 'Unknown error';
          throw new Error(msg);
        }

        const json = await response.json();

        // 3) Hide spinner
        document.getElementById('loading').classList.add('hidden');

        // 4) If JSON includes an error, display it
        if (json.error) {
          const errMsg = json.error.message || 'Unknown error';
          const rc = document.getElementById('reportContainer');
          rc.classList.remove('hidden');
          rc.innerHTML = `<p class="text-red-600 text-center">Error: ${errMsg}</p>`;
          return;
        }

        // 5) Extract the raw text (plain-text, no Markdown)
        const raw = json.choices?.[0]?.message?.content || 'No content returned.';

        // 6) Split raw text into “blocks” by two or more line breaks
        const blocks = raw.split(/\n\s*\n/).map(b => b.trim()).filter(b => b.length > 0);

        // The first block is assumed to be the overall report heading (e.g., “Full AI Automation Opportunity Report”)
        const overallHeading = blocks.shift();

        // The remaining blocks should start with “Section N: [Title]”
        const sections = blocks.map((b, idx) => {
          // Split the block’s first line (Section header) from its body
          const lines = b.split('\n');
          const headerLine = lines[0].trim();
          const bodyLines = lines.slice(1).join('\n').trim();
          // Build a safe DOM id, e.g. “section-1” or “section-2”
          const id = `section-${idx + 1}`;
          return { id, header: headerLine, body: bodyLines };
        });

        // 7) Build Table of Contents
        const tocList = document.getElementById('tocList');
        sections.forEach(sec => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `#${sec.id}`;
          a.innerText = sec.header.replace(/^Section\s*\d+:\s*/, '');
          a.className = "text-indigo-600 hover:underline";
          li.appendChild(a);
          tocList.appendChild(li);
        });

        // 8) Render Each Section Header + Body
        const contentDiv = document.getElementById('reportContent');

        // First, render the overall heading as a “report subtitle”
        if (overallHeading) {
          const p = document.createElement('p');
          p.className = 'text-2xl font-semibold text-gray-800';
          p.innerText = overallHeading;
          contentDiv.appendChild(p);
        }

        // Then render each section
        sections.forEach(sec => {
          // Section header (bold, larger, with anchor id)
          const h3 = document.createElement('h3');
          h3.id = sec.id;
          h3.className = 'text-xl font-semibold text-gray-800';
          h3.innerText = sec.header;
          contentDiv.appendChild(h3);

          // Section body (preserve newlines as <br>)
          const p = document.createElement('p');
          p.className = 'pt-2 text-gray-800';
          p.innerHTML = sec.body.replace(/\n/g, '<br>');
          contentDiv.appendChild(p);
        });

        // 9) Reveal the container
        document.getElementById('reportContainer').classList.remove('hidden');
      } catch (err) {
        // Hide spinner, show error
        document.getElementById('loading').classList.add('hidden');
        const rc = document.getElementById('reportContainer');
        rc.classList.remove('hidden');
        rc.innerHTML = `<p class="text-red-600 text-center">Error fetching report: ${err.message}</p>`;
      }
    })();
  </script>
</body>
</html>
