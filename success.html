<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thank You! Your AI Audit is Ready</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* If you have a fixed header, this ensures that anchored sections are not hidden. */
    h3[id] {
      scroll-margin-top: 1.5rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex flex-col justify-center items-center p-4">
    <div class="w-full max-w-3xl">
      <!-- Main Heading -->
      <h1 class="text-4xl font-extrabold text-center mb-4">
        Thank you! Your AI Audit is Ready
      </h1>
      <p class="text-center text-lg text-gray-600 mb-8">
        Please hold on while we prepare a detailed, in-depth report tailored to your business.
      </p>
      <!-- Loading Spinner -->
      <div id="loading" class="flex justify-center mb-8">
        <svg
          class="animate-spin h-12 w-12 text-indigo-600"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
          ></path>
        </svg>
      </div>
      <!-- Table of Contents & Report Container -->
      <div id="reportContainer" class="hidden bg-white p-6 rounded-lg shadow-md">
        <!-- Table of Contents -->
        <div id="tableOfContents" class="mb-8">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Table of Contents</h2>
          <ul id="tocList" class="list-disc list-inside text-gray-700 space-y-2">
            <!-- Filled by JavaScript -->
          </ul>
        </div>
        <!-- Report Content -->
        <div id="reportContent" class="text-base leading-relaxed text-gray-800">
          <!-- Filled by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      // 1) Extract session_id from the URL
      const params = new URLSearchParams(location.search);
      const session_id = params.get('session_id');
      if (!session_id) {
        document.getElementById('loading').style.display = 'none';
        const rc = document.getElementById('reportContainer');
        rc.classList.remove('hidden');
        rc.innerHTML = '<p class="text-red-600 text-center">Error: Missing session_id in URL.</p>';
        return;
      }

      try {
        // 2) Fetch the advanced‐audit endpoint
        const response = await fetch(
          'https://api.aiauditpro.com/api/advanced-audit.php',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id })
          }
        );

        // 3) If not OK, pull out error message
        if (!response.ok) {
          const errJson = await response.json().catch(() => ({}));
          const msg = errJson.error?.message || 'Unknown error';
          throw new Error(msg);
        }

        const json = await response.json();

        // 4) Hide spinner
        document.getElementById('loading').classList.add('hidden');

        // 5) If JSON has an error, display it
        if (json.error) {
          const errMsg = json.error.message || 'Unknown error';
          const rc = document.getElementById('reportContainer');
          rc.classList.remove('hidden');
          rc.innerHTML = `<p class="text-red-600 text-center">Error: ${errMsg}</p>`;
          return;
        }

        // 6) Get the raw text from the model (plain text, no Markdown)
        const rawText = json.choices?.[0]?.message?.content || 'No content returned.';

        // 7) Split into lines
        const allLines = rawText.split('\n');

        // 8) Identify the very first non-empty line as the "overall heading"
        let overallHeading = '';
        let i = 0;
        while (i < allLines.length) {
          const line = allLines[i].trim();
          if (line.length) {
            overallHeading = line;
            i++;
            break;
          }
          i++;
        }

        // 9) Now, parse sections: 
        //    A section header is any line that begins with "Section " (case‐sensitive).
        const sections = [];
        let currentSection = null;

        for (; i < allLines.length; i++) {
          const line = allLines[i];
          const trimmed = line.trim();
          // If this line is exactly "Section N: Title...", start a new section.
          if (/^Section\s+\d+:\s+/.test(trimmed)) {
            // Push the previous section, if any
            if (currentSection) {
              sections.push(currentSection);
            }
            // Start a brand-new section
            const headerText = trimmed; 
            const id = headerText
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/(^-+|-+$)/g, '');
            currentSection = { header: headerText, id, bodyLines: [] };
          } else {
            // If we haven't yet started any section, skip it
            if (currentSection) {
              // Append this line to the body (including blank lines, which create paragraph breaks)
              currentSection.bodyLines.push(line);
            }
          }
        }
        // Push final section if it exists
        if (currentSection) {
          sections.push(currentSection);
        }

        // 10) Build the Table of Contents (only section headers, not full bodies)
        const tocList = document.getElementById('tocList');
        sections.forEach((sec) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `#${sec.id}`;
          // Remove the "Section N: " prefix for TOC label
          a.innerText = sec.header.replace(/^Section\s+\d+:\s+/, '');
          a.className = 'text-indigo-600 hover:underline';
          li.appendChild(a);
          tocList.appendChild(li);
        });

        // 11) Render the overall heading and all sections

        const contentDiv = document.getElementById('reportContent');

        // 11a) Overall heading
        if (overallHeading) {
          const p = document.createElement('p');
          p.className = 'text-2xl font-semibold text-gray-800 mb-6';
          p.innerText = overallHeading;
          contentDiv.appendChild(p);
        }

        // 11b) Each section: <h3 id="...">Section N: Title</h3> + paragraphs
        sections.forEach((sec) => {
          // Section Header
          const h3 = document.createElement('h3');
          h3.id = sec.id;
          h3.className = 'text-xl font-semibold text-gray-800 mt-6 mb-2';
          h3.innerText = sec.header;
          contentDiv.appendChild(h3);

          // Join bodyLines into paragraphs—split on blank lines to get paragraphs
          const joinedBody = sec.bodyLines.join('\n');
          const paras = joinedBody.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length);

          paras.forEach((paraText) => {
            const p = document.createElement('p');
            p.className = 'text-gray-800 mb-4';
            // Preserve any single newlines inside a paragraph as <br>
            p.innerHTML = paraText.replace(/\n/g, '<br>');
            contentDiv.appendChild(p);
          });
        });

        // 12) Reveal the container
        document.getElementById('reportContainer').classList.remove('hidden');
      } catch (err) {
        // Hide spinner, show error
        document.getElementById('loading').classList.add('hidden');
        const rc = document.getElementById('reportContainer');
        rc.classList.remove('hidden');
        rc.innerHTML = `<p class="text-red-600 text-center">Error fetching report: ${err.message}</p>`;
      }
    })();
  </script>
</body>
</html>
